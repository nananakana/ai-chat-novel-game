# 開発依頼書_Phase2.1_AI応答パーサーの緊急修正

**宛先**: AI開発エンジニア  
**差出人**: プロジェクトマネージャー (Gemini)  
**依頼日**: 2025年7月1日

## 1. 背景・目的

先日実施したPhase 2の改修において、AIの応答を処理するパーサーに論理的な欠陥があることが判明した。現在のパーサーは、AIからの応答がJSON配列 `[...]` の場合にしか対応しておらず、単一のJSONオブジェクト `{...}` の場合に対応できていない。

この結果、AIが単一のメッセージを返却した際に、JSON文字列がそのまま画面に表示されるという致命的な不具合が発生している。

本依頼の目的は、このパーサーのロジックを修正し、単一オブジェクトと配列の両方の応答形式に完全対応させることである。

## 2. 依頼タスク：parseAIResponse 関数の改修

`hooks/useGameLogic.ts` 内に存在する `parseAIResponse` 関数、またはそれに類するAI応答の解釈処理を行っている関数に対して、以下の修正を加えよ。

1. 現在のロジックは、まずJSON配列 `[...]` の存在をチェックしている。これは正しいので、そのまま残す。

2. JSON配列が見つからなかった場合に、新たに「単一のJSONオブジェクト `{...}` を探してパースする」という処理ブロックを追加せよ。

3. 単一オブジェクトのパースに成功した場合も、配列の場合と同様に、speaker, text, event 等のキーを持つオブジェクトとして整形して返却すること。

4. 配列でも単一オブジェクトでもない、どちらのJSON形式とも一致しない場合に限り、最終手段として応答をプレーンテキストとして扱うこと。

### 修正ロジックのイメージ

```typescript
function parseAIResponse(responseText) {
  // 1. まず、JSON配列を探す（既存のロジック）
  try {
    const arrayMatch = responseText.match(/\[.*\]/s);
    if (arrayMatch) {
      const parsedArray = JSON.parse(arrayMatch[0]);
      // ... 配列を処理するロジック ...
      return ( /* 整形されたオブジェクト */ );
    }
  } catch(e) { /* ignore */ }

  // 2.【ここからが追加】次に、単一のJSONオブジェクトを探す
  try {
    const objectMatch = responseText.match(/\{.*\}/s);
    if (objectMatch) {
        const parsedObject = JSON.parse(objectMatch[0]);
        // ... 単一オブジェクトを処理するロジック ...
        return ( /* 整形されたオブジェクト */ );
    }
  } catch(e) { /* ignore */ }

  // 3. どちらでもない場合、プレーンテキストとして扱う
  return { speaker: 'ナレーター', text: responseText, event: null };
}
```

## 3. 受入基準

- AIが単一のJSONオブジェクト `{...}` を返却した際に、JSON文字列が表示されることなく、textの内容が正しく表示され、eventが実行されること。

- AIがJSON配列 `[{...}, {...}]` を返却した際に、連続メッセージ表示機能が引き続き正常に動作すること。