# 開発依頼書_最終章_インタラクティブ会話劇の実装

**宛先**: AI開発エンジニア  
**差出人**: プロジェクトマネージャー (Gemini)  
**依頼日**: 2025年7月1日

## 1. 背景・目的

現在のシステムは、AIが単一の応答しか返せないため、キャラクター同士の掛け合いや、ナレーションを交えた豊かな物語展開が実現できていない。

本依頼の目的は、AIに**「連続した対話やナレーションのシーケンス（一連の流れ）」を生成させることで、プレイヤーの行動に対して、よりダイナミックで没入感のある「インタラクティブな会話劇」**を自動生成するアーキテクチャを完成させることである。

## 2. 依頼タスク：システムプロンプトと処理系の最終改修

### Task 1: システムプロンプトの改修（AIへの指示変更）

AIに与えるシステムプロンプトを改修し、出力を必ずJSONの配列 `[...]` 形式で行うよう、厳格に指示せよ。

**指示内容**: 「プレイヤーの入力に対し、キャラクターの掛け合い、ナレーション、状況説明などを自由に組み合わせ、必ず複数のJSONオブジェクトを含む配列として応答を生成してください」と明確に命令する。

**出力形式の例を、プロンプト内に具体的に記述する。**

プロンプトに含める出力例:

```json
[
  {
    "speaker": "ニック",
    "text": "おい、アキラ！さっきから様子がおかしいぞ。何か隠してるんじゃないか？"
  },
  {
    "speaker": "アキラ",
    "text": "……別に。お前には関係ないだろ。",
    "event": { "character_update": [{ "name": "アキラ", "emotion": "angry" }] }
  },
  {
    "speaker": "ナレーター",
    "text": "二人の間に、張り詰めた空気が流れる。"
  }
]
```

### Task 2: AI応答処理ロジックの単純化

**現状**: 現在のparseAIResponse関数は、単一オブジェクトと配列の両方に対応するため、複雑なロジックになっている。

**改修方針**: AIの出力が常にJSON配列 `[...]` になることを前提とし、パーサーのロジックを**「配列をパースする処理」のみに単純化**する。単一オブジェクトを処理するロジックは不要となるため、削除せよ。

これにより、先日まで我々を苦しめた問題が再発するリスクを根本から断ち切ることができる。

## 3. 受入基準

- プレイヤーがキャラクターに話しかけた際、そのキャラクターだけでなく、他のキャラクターやナレーションも含む、複数のメッセージが連続して表示されること
- キャラクター同士が、互いの発言に反応しあうような、自然な会話劇が生成されること
- AIからの応答が、常にJSON配列形式で返ってくること