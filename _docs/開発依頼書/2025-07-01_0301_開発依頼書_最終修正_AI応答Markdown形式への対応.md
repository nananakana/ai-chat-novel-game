# 開発依頼書_最終修正_AI応答Markdown形式への対応

**宛先:** AI開発エンジニア  
**差出人:** プロジェクトマネージャー (Gemini)  
**依頼日:** 2025年7月1日

## 1. 背景・目的

最終デバッグにより、AIがJSON応答をMarkdownのコードブロック（```json ... ```）で囲んで返却することがあり、これが原因でパーサーが解析に失敗し、UIに「...」と表示される問題の根本原因が特定された。

本依頼の目的は、このMarkdown形式をパーサーが正しく処理できるように**「超堅牢化」**し、AIの応答形式に関わらず、常に安定してデータを解釈できるアーキテクチャを完成させることである。

## 2. 依頼タスク：`parseAIResponse` 関数の最終改修

`hooks/useGameLogic.ts` ファイルに存在する `parseAIResponse` 関数を、以下のロジックを持つ新しい関数に**完全に置き換える**こと。

### 新しい `parseAIResponse` 関数の仕様

1. まず、受け取ったテキスト全体から、正規表現 `/```json\n([\s\S]*?)\n```/` を用いて**Markdownコードブロックの中身を抽出**することを試みる。
2. 抽出に成功した場合、以降のパース処理はその**抽出した文字列**に対して行う。
3. 抽出に失敗した場合（コードブロックがない場合）、受け取ったテキスト全体をパース処理の対象とする。
4. その上で、これまで通り「JSON配列形式」「単一JSONオブジェクト形式」の順でパースを試みる。
5. 全てのパースに失敗した場合にのみ、プレーンテキストとして処理する。

### 実装コード例

```typescript
const parseAIResponse = (text) => {
  let jsonText = text.trim();

  // ステップ1: MarkdownコードブロックからJSON部分を抽出
  const markdownMatch = jsonText.match(/```json\n([\s\S]*?)\n```/);
  if (markdownMatch && markdownMatch[1]) {
    jsonText = markdownMatch[1];
  }

  // ステップ2: JSON配列としてパースを試みる
  try {
    if (jsonText.startsWith('[')) {
      const parsed = JSON.parse(jsonText);
      if (Array.isArray(parsed) && parsed.length > 0) {
        const firstMessage = parsed[0];
        return {
          speaker: firstMessage.speaker || 'ナレーター',
          text: firstMessage.text || '', // '...'のフォールバックを削除
          event: firstMessage.event || null,
          scene_characters: firstMessage.scene_characters || [],
          additional_messages: parsed.slice(1)
        };
      }
    }
  } catch (e) {
    console.warn('JSON配列のパースに失敗:', e);
  }

  // ステップ3: 単一JSONオブジェクトとしてパースを試みる
  try {
    if (jsonText.startsWith('{')) {
      const parsed = JSON.parse(jsonText);
      return {
        speaker: parsed.speaker || 'ナレーター',
        text: parsed.text || '', // '...'のフォールバックを削除
        event: parsed.event || null,
        scene_characters: parsed.scene_characters || []
      };
    }
  } catch (e) {
    console.warn('JSON単一オブジェクトのパースに失敗:', e);
  }

  // ステップ4: 最終フォールバック
  return {
    speaker: 'ナレーター',
    text: text, // 元のテキスト全体を返す
    event: null,
    scene_characters: []
  };
};
```

### 重要な変更点

1. **Markdown抽出ロジックの追加**
2. `text: parsed.text || '...'`となっていた部分を、`text: parsed.text || ''`に修正し、意図せず「...」が表示されることを防ぐ

## 3. 受入基準

- AIの応答がMarkdownのコードブロックで囲まれていても、正しくJSONとして解釈され、メッセージ本文が表示されること
- AIの応答がJSONむき出しの場合でも、正しく解釈されること
- キャラクターが登場する、しないに関わらず、全ての応答が正しく画面に表示されること
- UIに「...」だけが表示される問題が完全に解消されていること