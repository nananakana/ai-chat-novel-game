# 開発依頼書_Phase2_コアシステムのバグ撲滅

**宛先**: AI開発エンジニア  
**差出人**: プロジェクトマネージャー (Gemini)  
**依頼日**: 2025年7月1日

## 1. 背景・目的

Phase 1の成功により、我々の開発環境の安全性が確認された。次のステップとして、新機能の追加に先立ち、以前からアプリケーションの安定性を損なっていた2つの重大なバグを完全に修正する。

本依頼の目的は、これらのバグを撲滅し、今後の大規模改修に耐えうる、盤石なアプリケーション基盤を構築することである。

## 2. 依頼タスク一覧

以下の2つのタスクを、記載の順番通りに、それぞれ独立して完了させること。

### Task 2.1: 連続メッセージ表示機能の実装

**現状の問題**: AIが複数のメッセージブロック（例: ナレーションとセリフ）をJSON配列として返却しても、最初のブロックしか画面に表示されず、物語が途切れてしまう。

**実装方針**:

1. AIからの応答を処理するロジック（hooks/useGameLogic.ts内にある可能性が高い）を特定し、改修する。

2. 応答がJSON配列形式（例: `[{"speaker": "...", "text": "..."}, {"speaker": "...", "text": "..."}]`）であるかを判定するロジックを追加する。

3. 応答が配列の場合、各メッセージオブジェクトをキュー（一時的な待機リスト）に追加する。

4. setInterval または再帰的な setTimeout を用い、キューからメッセージを1つずつ取り出し、適切な間隔（例: 1.5秒）を空けながら画面に表示する処理を実装する。これにより、キャラクター同士がテンポよく会話しているような演出を実現する。

**受入基準**: AIが2つ以上のメッセージブロックを返した場合、それらがすべて、設定した間隔で順番に画面に表示されること。

### Task 2.2: 背景変更システムの完全安定化

**現状の問題**: 背景を変更しようとすると、「読み込み中」のスピナーが表示されたまま、処理が停止してしまうことがある。

**実装方針**:

1. 背景画像の読み込みを処理しているコンポーネント（App.tsx内にある可能性が高い）を特定し、改修する。

2. 現在の画像プリロード処理を、より堅牢で現代的な**Promiseベースの非同期処理**に完全に書き換えること。

3. new Image() オブジェクトを使用する際、onload（成功時）と onerror（失敗時）の両方のイベントハンドラを必ず設定し、どちらの場合でも確実に「読み込み中」のstateがfalseに更新されるようにする。

4. （推奨）読み込み処理にタイムアウト（例: 10秒）を設定し、万が一タイムアウトした場合でも、エラーメッセージを表示してスピナーを非表示にする処理を追加する。

**受入基準**: 背景変更処理が100%成功または失敗で完了し、「読み込み中」のスピナーが決して画面に残り続けないこと。